{% extends 'base.html' %}

{% block head %}


{% endblock %}

{% block body %}
<h1>Test</h1>
<div id="displayBox">
</div>
<div id="responseBox" class="hidden">
    <form action="/" method="POST">
        <input type="text" name="response" id="userResponse" placeholder="What was the response?">
        <button type="button" id="responseButton">Confirm</button>
    </form>
    <div id="ShowOptions">
        <button id="advanceButton" name="continue"></button>
        <button id="retryButton" name="retry">Retry?</button>
    </div>
    <form action="/finish" method="POST" id="response-form">
    </form>
</div>
<button type="button" id="returnButton">
    <a href="/">Return</a>
</button>
<script>
/* ==== VARIABLES ==== */
let numberString = {{ num_sequence | tojson }};
let numberList = {{ num_list | tojson }};
let displayBox = document.getElementById("displayBox");
let responseBox = document.getElementById("responseBox");
let responseButton = document.getElementById("responseButton");
let advanceButton = document.getElementById("advanceButton");
let retryButton = document.getElementById("retryButton");
let dspan = numberString.length;
let continueGame = false;

/* ==== HELPER FUNCTION TO WAIT ==== */
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

/* ==== SEND DATA TO BACKEND ==== */
async function sendData(dspan) {
    console.log("Sending data to backend:", dspan);
    
    const response = await fetch("/finish", {
        method: "POST",
        headers: {"Content-Type": "application/json" },
        body: JSON.stringify({ dspan: dspan })
    });

    const data = await response.json();
    numberList = data.num_list;
    numberString = data.num_sequence;
    dspan = data.dspan;

    // Show the next round
    showNextNumber();
}

/* ==== SHOW NEXT NUMBER SEQUENCE ==== */
async function showNextNumber() {
    responseBox.classList.remove("present");
    displayBox.classList.remove("hidden");

    for (let i = 0; i < numberList.length; i++) {
        displayBox.textContent = numberList[i];
        console.log(numberList[i])
        await sleep(1000);
    }

    displayBox.classList.add("hidden");
    responseBox.classList.add("present");
    dspan++;  // Increment sequence length for next round
}

/* ==== INITIALIZE EVENT LISTENERS ==== */
function setupEventListeners() {
    // Response button click
    responseButton.addEventListener("click", () => {
        const userResponse = document.getElementById("userResponse").value;
        if (userResponse === numberString) {
            // Correct answer → enable advance
            advanceButton.textContent = `Try ${numberString.length + 1} numbers next?`;
        } else {
            // Wrong answer → enable retry
            retryButton.textContent = "Retry?";
        }
    });

    // Advance / Retry buttons click (delegation on responseBox)
    responseBox.addEventListener("click", (event) => {
        if (event.target.id === "advanceButton") {
            sendData(dspan); // Only send once per click
        }
        if (event.target.id === "retryButton") {
            continueGame = false;
            console.log("Retry clicked. Resetting sequence...");
            // Optionally reset sequence here
        }
    });
}

/* ==== START GAME ==== */
setupEventListeners();
showNextNumber();  // Kick off the first sequence
</script>

{% endblock %}